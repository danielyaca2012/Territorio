<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Topograf√≠a ‚Äì Lanzarote</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html,body{
  height:100%;
  margin:0;
  font-family:Arial,Helvetica,sans-serif;
}

#top{
  padding:8px;
  background:#0b7;
  color:#042;
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}

#map{
  height:calc(100vh - 80px);
  width:100%;
}

button{
  padding:10px 14px;
  border-radius:6px;
  border:1px solid #999;
  cursor:pointer;
  font-size:0.9rem;
  background:white;
}

label{
  display:flex;
  align-items:center;
  gap:4px;
  font-size:0.9rem;
}

#nucleo{font-weight:bold}
.boton-volver{margin-left:auto;font-weight:bold}

#mensaje,#estadisticas{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:rgba(0,0,0,0.75);
  color:white;
  padding:20px;
  border-radius:12px;
  display:none;
  z-index:1000;
  text-align:center;
}

#mensaje{font-size:2.5rem}
</style>
</head>

<body>

<div id="top">
  <button id="start">‚ñ∂ Iniciar</button>
  <button id="repaso">üìç Repaso</button>

  <label><input type="checkbox" id="chkMontanas" checked> üèî Monta√±as</label>
  <label><input type="checkbox" id="chkErmitas" checked> ‚õ™ Ermitas</label>

  <span id="progreso">‚Äî/‚Äî</span>
  <span id="nucleo">‚Äî</span>
  <span id="fallos">Fallos: 0</span>

  <button class="boton-volver" onclick="volverInicio()">‚¨Ö Volver</button>
</div>

<div id="mensaje"></div>
<div id="estadisticas"></div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// =====================
// VARIABLES
// =====================
let map = L.map('map').setView([29.0,-13.6],10);
let todosLosPuntos = [];
let puntosActivos = [];
let order = [];
let index = 0;
let marcadores = [];
let fallosTotales = 0;
let juegoTerminado = false;
let modoRepaso = false;

// =====================
// MAPA
// =====================
L.tileLayer(
  'https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png'
).addTo(map);

// =====================
// CARGA GEOJSON
// =====================
Promise.all([
  fetch("topografia.geojson").then(r=>r.json()),
  fetch("ermitas.geojson").then(r=>r.json())
]).then(([montanas,ermitas])=>{

  montanas.features.forEach(f=>{
    todosLosPuntos.push({
      nombre:f.properties.nombre,
      lat:f.geometry.coordinates[1],
      lng:f.geometry.coordinates[0],
      tipo:"montana",
      acertado:false
    });
  });

  ermitas.features.forEach(f=>{
    todosLosPuntos.push({
      nombre:f.properties.nombre,
      lat:f.geometry.coordinates[1],
      lng:f.geometry.coordinates[0],
      tipo:"ermita",
      acertado:false
    });
  });

  actualizarFiltro();
});

// =====================
// FILTRO
// =====================
function actualizarFiltro(){
  const usarMontanas=document.getElementById("chkMontanas").checked;
  const usarErmitas=document.getElementById("chkErmitas").checked;

  puntosActivos = todosLosPuntos.filter(p=>
    (p.tipo==="montana" && usarMontanas) ||
    (p.tipo==="ermita" && usarErmitas)
  );
}

// =====================
// UTILIDADES
// =====================
function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

function mostrarMensaje(txt){
  const m=document.getElementById("mensaje");
  m.textContent=txt;
  m.style.display="block";
  setTimeout(()=>m.style.display="none",700);
}

// =====================
// BOTONES
// =====================
document.getElementById("start").onclick=()=>{
  actualizarFiltro();
  if(puntosActivos.length===0) return;

  modoRepaso=false;
  juegoTerminado=false;
  fallosTotales=0;
  index=0;

  todosLosPuntos.forEach(p=>p.acertado=false);
  document.getElementById("fallos").textContent="Fallos: 0";
  document.getElementById("estadisticas").style.display="none";

  clearMap();
  order = shuffle([...puntosActivos]);
  nextRound();
};

document.getElementById("repaso").onclick=()=>{
  actualizarFiltro();
  modoRepaso=true;
  juegoTerminado=true;
  clearMap();
  mostrarTodos(true);
  document.getElementById("nucleo").textContent="Modo repaso";
  document.getElementById("progreso").textContent="";
};

// =====================
// JUEGO
// =====================
function nextRound(){
  clearMap();

  if(index>=order.length){
    juegoTerminado=true;
    mostrarTodos(false);
    mostrarEstadisticas();
    return;
  }

  document.getElementById("nucleo").textContent=order[index].nombre;
  document.getElementById("progreso").textContent=`${index+1}/${order.length}`;

  puntosActivos.forEach(p=>{
    const color=p.tipo==="ermita"?"purple":"blue";

    const m=L.circleMarker([p.lat,p.lng],{
      radius:10,
      color:p.acertado?"green":color,
      fillOpacity:0.6
    }).addTo(map);

    m.on("click",()=>{
      if(juegoTerminado||modoRepaso) return;

      if(p.nombre===order[index].nombre){
        p.acertado=true;
        mostrarMensaje("‚úî");
        index++;
        nextRound();
      }else{
        fallosTotales++;
        m.setStyle({color:"red"});
        document.getElementById("fallos").textContent=
          `Fallos: ${fallosTotales}`;
      }
    });

    marcadores.push(m);
  });
}

// =====================
function mostrarTodos(permanente){
  puntosActivos.forEach(p=>{
    const color=p.tipo==="ermita"?"purple":"blue";

    const m=L.circleMarker([p.lat,p.lng],{
      radius:10,
      color:p.acertado?"green":color,
      fillOpacity:0.6
    }).addTo(map);

    m.bindTooltip(p.nombre,{permanent, direction:"top"});
    marcadores.push(m);
  });
}

// =====================
function mostrarEstadisticas(){
  const total=puntosActivos.length;
  const acertados=puntosActivos.filter(p=>p.acertado).length;
  const porcentaje=Math.round((acertados/total)*100);

  const e=document.getElementById("estadisticas");
  e.innerHTML=`
    <h2>üìä Resultados</h2>
    Elementos: ${total}<br>
    Fallos: ${fallosTotales}<br>
    Aciertos: ${acertados}<br><br>
    üéØ Precisi√≥n: ${porcentaje}%
  `;
  e.style.display="block";
}

// =====================
function clearMap(){
  marcadores.forEach(m=>map.removeLayer(m));
  marcadores=[];
}

function volverInicio(){
  window.location.href="/Territorio/Lanzarote/Interes/interes_menu.html";
}
</script>

</body>
</html>
