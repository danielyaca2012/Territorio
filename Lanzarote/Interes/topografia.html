<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>TopografÃ­a y Puntos de InterÃ©s â€“ Lanzarote</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html,body{
  height:100%;
  margin:0;
  font-family:Arial,Helvetica,sans-serif;
}

#top{
  padding:8px;
  background:#0b7;
  color:#042;
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}

#map{
  height:calc(100vh - 100px);
  width:100%;
}

button{
  padding:10px 14px;
  border-radius:6px;
  border:1px solid #999;
  cursor:pointer;
  background:white;
}

label{
  display:flex;
  align-items:center;
  gap:4px;
  font-size:0.9rem;
}

#nucleo{font-weight:bold}
.boton-volver{margin-left:auto;font-weight:bold}

#mensaje,#estadisticas{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:rgba(0,0,0,0.75);
  color:white;
  padding:20px;
  border-radius:12px;
  display:none;
  z-index:1000;
  text-align:center;
}

#mensaje{font-size:2.5rem}
</style>
</head>

<body>

<div id="top">
  <button id="start">â–¶ Iniciar</button>
  <button id="repaso">ğŸ“ Repaso</button>
  <label><input type="checkbox" id="chkMontanas" checked> â›° MontaÃ±as</label>
  <label><input type="checkbox" id="chkErmitas" checked> â›ª Ermitas</label>
  <label><input type="checkbox" id="chkIglesias" checked> ğŸ› Iglesias</label>
  <label><input type="checkbox" id="chkCastillos" checked> ğŸ° Castillos</label>
  <label><input type="checkbox" id="chkPlayas" checked> ğŸ– Playas</label>
  <label><input type="checkbox" id="chkBarrancos" checked> ğŸŒ„ Barrancos</label>
  <label><input type="checkbox" id="chkPoblaciones" checked> ğŸ§‘â€ğŸ¤â€ğŸ§‘ NÃºcleos</label>


  <span id="progreso">â€”/â€”</span>
  <span id="nucleo">â€”</span>
  <span id="fallos">Fallos: 0</span>
  <label><input type="checkbox" id="chkCarreteras"> ğŸ›£ Mostrar carreteras</label>

  <button class="boton-volver" onclick="volverInicio()">â¬… Volver</button>
</div>

<div id="mensaje"></div>
<div id="estadisticas"></div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map = L.map('map').setView([29.0,-13.6],10);
let todosLosPuntos=[];
let puntosActivos=[];
let order=[];
let index=0;
let marcadores=[];
let fallosTotales=0;
let juegoTerminado=false;
let modoRepaso=false;
let capaCarreteras = null;
let carreterasCargadas = false;


L.tileLayer(
  'https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png'
).addTo(map);

// =====================
// CARGA GEOJSON
// =====================
Promise.all([
  fetch("topografia.geojson").then(r=>r.json()),
  fetch("ermitas.geojson").then(r=>r.json()),
  fetch("iglesias.geojson").then(r=>r.json()),
  fetch("castillos.geojson").then(r=>r.json()),
  fetch("playas.geojson").then(r=>r.json()),
  fetch("barrancos_valles.geojson").then(r=>r.json()),
  fetch("poblaciones.geojson").then(r=>r.json())
]).then(([montanas,ermitas,iglesias,castillos,playas,barrancos,poblaciones])=>{
  cargar(montanas,"montana");
  cargar(ermitas,"ermita");
  cargar(iglesias,"iglesia");
  cargar(castillos,"castillo");
  cargar(playas,"playa");
  cargar(barrancos,"barranco");
  cargar(poblaciones,"poblacion");
  actualizarFiltro();
});


function cargar(data,tipo){
  data.features.forEach(f=>{
    todosLosPuntos.push({
      nombre:f.properties.nombre,
      lat:f.geometry.coordinates[1],
      lng:f.geometry.coordinates[0],
      tipo,
      acertado:false
    });
  });
}

  function cargarCarreteras(){
  if(carreterasCargadas) return;

  fetch("/Territorio/Lanzarote/juegos_carreteras/carreteras_lanzarote_fin.geojson")
    .then(r=>r.json())
    .then(data=>{
      capaCarreteras = L.geoJSON(data,{
        style: {
          color: "#000",
          weight: 2,
          opacity: 0.15   // ğŸ‘ˆ muy poca opacidad
        },
        onEachFeature: (feature, layer)=>{
          if(feature.properties && feature.properties.ref){
            layer.bindTooltip(
              feature.properties.ref,
              {sticky:true}
            );
          }
        }
      });

      carreterasCargadas = true;
      if(chkCarreteras.checked){
        capaCarreteras.addTo(map);
      }
    });
}


// =====================
function actualizarFiltro(){
  puntosActivos=todosLosPuntos.filter(p=>
    (p.tipo==="montana" && chkMontanas.checked) ||
    (p.tipo==="ermita" && chkErmitas.checked) ||
    (p.tipo==="iglesia" && chkIglesias.checked) ||
    (p.tipo==="castillo" && chkCastillos.checked) ||
    (p.tipo==="playa" && chkPlayas.checked) ||
    (p.tipo==="barranco" && chkBarrancos.checked) ||
    (p.tipo==="poblacion" && chkPoblaciones.checked)
  );
}


function colorTipo(t){
  return {
    montana:"blue",
    ermita:"purple",
    iglesia:"yellow",
    castillo:"black",
    playa:"lightblue",
    barranco:"brown",
    poblacion:"silver"
  }[t] || "gray";
}


// =====================
start.onclick=()=>{
  actualizarFiltro();
  if(!puntosActivos.length) return;

  modoRepaso=false;
  juegoTerminado=false;
  fallosTotales=0;
  index=0;
  todosLosPuntos.forEach(p=>p.acertado=false);
  fallos.textContent="Fallos: 0";
  estadisticas.style.display="none";

  clearMap();
  order=shuffle([...puntosActivos]);
  nextRound();
};

repaso.onclick=()=>{
  actualizarFiltro();
  modoRepaso=true;
  juegoTerminado=true;
  clearMap();
  mostrarTodos(true);
  nucleo.textContent="Modo repaso";
  progreso.textContent="";
};

function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

function nextRound(){
  clearMap();
  if(index>=order.length){
    mostrarTodos(false);
    mostrarEstadisticas();
    return;
  }

  nucleo.textContent=order[index].nombre;
  progreso.textContent=`${index+1}/${order.length}`;

  puntosActivos.forEach(p=>{
    const m=L.circleMarker([p.lat,p.lng],{
      radius:10,
      color:p.acertado?"green":colorTipo(p.tipo),
      fillOpacity:0.6
    }).addTo(map);

    m.on("click",()=>{
      if(juegoTerminado||modoRepaso) return;
      if(p.nombre===order[index].nombre){
        p.acertado=true;
        index++;
        nextRound();
      }else{
        fallosTotales++;
        m.setStyle({color:"red"});
        fallos.textContent=`Fallos: ${fallosTotales}`;
      }
    });

    marcadores.push(m);
  });
}

function mostrarTodos(permanente){
  puntosActivos.forEach(p=>{
    const m=L.circleMarker([p.lat,p.lng],{
      radius:10,
      color:p.acertado?"green":colorTipo(p.tipo),
      fillOpacity:0.6
    }).addTo(map);

    m.bindTooltip(p.nombre,{permanent:permanente,direction:"top"});
    marcadores.push(m);
  });
}

function mostrarEstadisticas(){
  const total=puntosActivos.length;
  const aciertos=puntosActivos.filter(p=>p.acertado).length;
  estadisticas.innerHTML=`
    <h2>ğŸ“Š Resultados</h2>
    Elementos: ${total}<br>
    Fallos: ${fallosTotales}<br>
    Aciertos: ${aciertos}
  `;
  estadisticas.style.display="block";
}

function clearMap(){
  marcadores.forEach(m=>map.removeLayer(m));
  marcadores=[];
}

function volverInicio(){
  location.href="/Territorio/Lanzarote/Interes/interes_menu.html";
}


  // =====================
// ACTUALIZAR REPASO EN TIEMPO REAL
// =====================
[
  chkMontanas,
  chkErmitas,
  chkIglesias,
  chkCastillos,
  chkPlayas,
  chkBarrancos,
  chkPoblaciones
].forEach(chk=>{
  chk.addEventListener("change",()=>{
    actualizarFiltro();
    if(modoRepaso){
      clearMap();
      mostrarTodos(true);
    }
  });
});
chkCarreteras.addEventListener("change",()=>{
  if(chkCarreteras.checked){
    cargarCarreteras();
    if(capaCarreteras) capaCarreteras.addTo(map);
  }else{
    if(capaCarreteras) map.removeLayer(capaCarreteras);
  }
});


</script>

</body>
</html>
