 <!DOCTYPE html>

<html lang="es">  
<head>  
<meta charset="utf-8" />  
<title>Juego de conexiones â€“ Lanzarote</title>  
<meta name="viewport" content="width=device-width, initial-scale=1" />  
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>  <style>  
html,body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#0b7;}  
#top{  
  padding:10px;background:#0a6;color:#042;  
  display:flex;gap:10px;align-items:center;flex-wrap:wrap;  
}  
#contenedor{max-width:820px;margin:18px auto;padding:10px;}  
.caja{background:white;border-radius:12px;padding:14px;margin-bottom:12px;  
box-shadow:0 4px 10px rgba(0,0,0,.12);}  
.titulo{font-weight:700;font-size:1.1rem;margin-bottom:8px;}  
.lista{display:flex;flex-wrap:wrap;gap:8px;}  
.item{padding:6px 10px;border-radius:8px;background:#e6f7f3;cursor:pointer;}  
.item.sel{box-shadow:inset 0 0 0 2px #0b7;background:#d1f0e6;}  
.item.ok{background:#c8f7c5;}  
.item.bad{background:#f7c5c5;}  
.item.miss{background:#eee;color:#666;}  
.drag{cursor:grab;}  
button{padding:8px 12px;border-radius:8px;border:none;background:#0b7;color:white;cursor:pointer;}  
button:hover{background:#099;}  
#map{height:320px;border-radius:10px;}  
.controles{display:flex;gap:10px;justify-content:center;}  

 .leaflet-tooltip {
  background: #1f2937;
  color: white;
  border-radius: 6px;
  padding: 4px 8px;
  border: none;
  font-size: 13px;
}

  
#estadisticas{  
  position:fixed;top:50%;left:50%;  
  transform:translate(-50%,-50%);  
  background:rgba(0,0,0,.8);color:white;  
  padding:30px 40px;border-radius:14px;  
  display:none;z-index:2000;text-align:center;  
}  
</style>  </head>  <body>  <div id="top">  
  <button id="btnIniciar">ğŸ“ Iniciar examen</button>  
  <button id="btnRepaso">ğŸ“– Modo repaso</button>  <label><input type="checkbox" id="chkPrim" checked> Primarias</label>
<label><input type="checkbox" id="chkSec" checked> Secundarias</label>
<label><input type="checkbox" id="chkTer" checked> Terciarias</label>

<strong>Correctas: <span id="correctas">0</span></strong>
<strong>Fallos: <span id="fallos">0</span></strong>
<input
id="buscador"
placeholder="Buscar carretera (LZ-2)"
style="
display:none;
padding:6px 10px;
border-radius:8px;
border:none;
outline:none;
"

> 

<button style="margin-left:auto" onclick="volver()">â¬… Volver</button>

</div>  <div id="contenedor">  <div class="caja">  
  <div id="tituloFicha" class="titulo">â€”</div>  
  <div id="descFicha"></div>  
</div>  <div class="caja">  
  <strong>ğŸ“ Municipios (Seleccionar)</strong>  
  <div id="municipios" class="lista"></div>  
</div>  <div class="caja">  
  <strong>ğŸ˜ï¸ Pasa por (Ordenar)</strong>  
  <div id="pasaPor" class="lista"></div>  
</div>  
 <div class="caja" id="boxConecta" style="display:none">
  <strong>ğŸ”— Conecta con (Seleccionar)</strong>
  <div id="conecta" class="lista"></div>
</div>

 
 <div class="caja">  
  â–¶ Inicio: <span id="inicio">â€”</span><br>  
  â¹ Final: <span id="final">â€”</span>  
</div>  <div class="caja"><div id="map"></div></div>  <div class="controles">  
  <button id="btnCorregir">âœ” Corregir</button>  
  <button id="btnSiguiente">Siguiente â¡</button>  
</div>  </div>  <div id="estadisticas"></div>  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>  <script src="data_carreteras.js"></script>  <script>  
/* ================= MAPA ================= */  
const map=L.map("map").setView([28.96,-13.60],11);  
L.tileLayer("https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png").addTo(map);  
  
let geoData, baseLayer, activeLayer;  
let modoRepaso=true;  
  
/* ================= GEOJSON ================= */  
fetch("carreteras_lanzarote_fin.geojson")  
.then(r=>r.json())  
.then(j=>{  
  geoData=j;  
  baseLayer=L.geoJSON(geoData,{  
    style:{color:"#3388ff",weight:4},  
    onEachFeature:(f,l)=>{  
  const ref = normalizarRef(f.properties.ref);

  // ğŸ–±ï¸ Hover â†’ nombre de carretera (solo repaso)
  l.bindTooltip(ref, {
    sticky: true,
    direction: "top",
    opacity: 0.9
  });

  l.on("click", () => {  
    if(!modoRepaso) return;  
    mostrarFicha(ref);  
  });  
}

  }).addTo(map);  
});  
  
/* ================= ESTADO ================= */  
let preguntas=[],idx=0;  
let correctas=0,fallos=0;  
let perfectas=0,conErrores=0;  
let attempts={},lastSig={};  
let seleccionadoPasaPor = null;
  
  
/* ================= UTIL ================= */  
function tipo(ref){  
  const n=parseInt(ref.replace(/\D/g,""));  
  if([1,2,3].includes(n))return"primaria";  
  if(n>=10&&n<=67)return"secundaria";  
  return"terciaria";  
}  
  function aplicarFiltrosRepaso(){  
  if(!modoRepaso || !baseLayer) return;  

  const usarPrim = chkPrim.checked;  
  const usarSec  = chkSec.checked;  
  const usarTer  = chkTer.checked;  

  baseLayer.eachLayer(l=>{
    const ref = normalizarRef(l.feature.properties.ref);
    const t = tipo(ref);  

    const visible =  
      (usarPrim && t==="primaria") ||  
      (usarSec  && t==="secundaria") ||  
      (usarTer  && t==="terciaria");  

    if(visible){  
      l.setStyle({  
        color:"#3388ff",  
        weight:4,  
        opacity:1  
      });  
    } else {  
      l.setStyle({ opacity:0 });  
    }  
  });  
}
  
  
  
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}}  
  
/* ================= MAP ================= */  
function highlight(ref,color){
  if(activeLayer) map.removeLayer(activeLayer);

  const refNorm = normalizarRef(ref);

  activeLayer=L.geoJSON(geoData,{
    filter:f => normalizarRef(f.properties.ref) === refNorm,
    style:{color,weight:6}
  }).addTo(map);

  map.fitBounds(activeLayer.getBounds(),{padding:[20,20]});
}
  
/* ================= UI ================= */  
function renderMunicipios(arr=[],sel=[]){  
  const c=municipios;c.innerHTML="";  
  arr.forEach(m=>{  
    const d=document.createElement("div");  
    d.className="item";d.textContent=m;  
    if(sel.includes(m))d.classList.add("sel");  
    d.onclick=()=>!modoRepaso&&d.classList.toggle("sel");  
    c.appendChild(d);  
  });  
}  
function renderPasaPor(arr){
  pasaPor.innerHTML="";

  arr.forEach((t,i)=>{
    const d=document.createElement("div");
    d.className="item";
    d.textContent=t;

    if(!modoRepaso){
      d.onclick=()=>{
        // primer toque
        if(seleccionadoPasaPor===null){
          seleccionadoPasaPor=i;
          d.classList.add("sel");
        }
        // segundo toque â†’ intercambiar
        else{
          const nuevo=[...arr];
          [nuevo[seleccionadoPasaPor],nuevo[i]] =
          [nuevo[i],nuevo[seleccionadoPasaPor]];
          seleccionadoPasaPor=null;
          renderPasaPor(nuevo);
        }
      };
    }

    pasaPor.appendChild(d);
  });
}


function renderConectaRepaso(arr = []) {
  boxConecta.style.display = "block";
  conecta.innerHTML = "";

  arr.forEach(ref => {
    const d = document.createElement("div");
    d.className = "item ok"; // verde directamente
    d.textContent = ref;
    conecta.appendChild(d);
  });
}

 
/* ================= REPASO ================= */  
  
function normalizarRef(ref){  
  return ref  
    .toUpperCase()  
    .replace(/\s+/g, "-")   // espacios â†’ guiones  
    .replace(/--+/g, "-"); // doble guiÃ³n â†’ simple  
}  
  
function entrarRepasoInicial(){  
  modoRepaso = true;  
  estadisticas.style.display = "none";  
  buscador.style.display = "inline";  
  
  municipios.innerHTML = "";  
  pasaPor.innerHTML = "";  
  
  aplicarFiltrosRepaso();  
  
  // âŒ NO seleccionar ninguna carretera aquÃ­  
  tituloFicha.textContent = "Selecciona una carretera";  
  descFicha.textContent = "";  
  inicio.textContent = "â€”";  
  final.textContent = "â€”";  
 boxConecta.style.display = "none";

}  

 function highlightConectadas(ref){
  const f = dataCarreteras[ref];
  if(!f || !f.conecta) return;

  baseLayer.eachLayer(l=>{
    const r = normalizarRef(l.feature.properties.ref);
    if(f.conecta.includes(r)){
      l.setStyle({ color:"#00bcd4", weight:5, opacity:1 });
    }
  });
}

  
function mostrarFicha(ref){  
ref = normalizarRef(ref);  
  const f=dataCarreteras[ref];  
  if(!f)return;  
 highlightConectadas(ref);

  tituloFicha.textContent=ref;  
  descFicha.textContent=f.descripcion||"";  
  inicio.textContent=f.inicio||"â€”";  
  final.textContent=f.final||"â€”";  
  renderMunicipios(f.municipios||[]);  
  renderPasaPor(f.pasaPor||[]);  
  // âœ… SOLO REPASO
  renderConectaRepaso(f.conecta || []);
  highlight(ref,"orange");  
}  
  
/* ================= EXAMEN ================= */  
function iniciar(){  
  estadisticas.style.display="none";  
  modoRepaso=false;  
  buscador.style.display="none";  
  preguntas=Object.entries(dataCarreteras)  
    .map(([r,o])=>({...o,ref:r,tipo:o.tipo||tipo(r)}))  
    .filter(o=>  
      (chkPrim.checked&&o.tipo==="primaria")||  
      (chkSec.checked&&o.tipo==="secundaria")||  
      (chkTer.checked&&o.tipo==="terciaria")  
    );  
  shuffle(preguntas);  
  idx=0;correctas=fallos=perfectas=conErrores=0;  
  attempts={};lastSig={};  
  actualizar();  
  mostrarPregunta();  
}  

 function renderConecta(correctas = []) {
  conecta.innerHTML = "";

  // Universo de carreteras (para distractores)
  const todas = Object.keys(dataCarreteras);

  // Mezclamos correctas + distractores
  const opciones = [...new Set([
    ...correctas,
    ...shuffleArray(
      todas.filter(r => !correctas.includes(r))
    ).slice(0, Math.max(3, 6 - correctas.length))
  ])];

  shuffle(opciones);

  opciones.forEach(ref => {
    const d = document.createElement("div");
    d.className = "item";
    d.textContent = ref;
    d.onclick = () => !modoRepaso && d.classList.toggle("sel");
    conecta.appendChild(d);
  });
}

 function shuffleArray(arr){
  const a=[...arr];
  shuffle(a);
  return a;
}

  
function mostrarPregunta(){  
  const f=preguntas[idx];  
  boxConecta.style.display = "block";
  renderConecta(f.conecta || []);

  tituloFicha.textContent=f.ref;  
  descFicha.textContent=f.descripcion||"";  
  inicio.textContent=f.inicio||"â€”";  
  final.textContent=f.final||"â€”";  
  renderMunicipios(["Arrecife","HarÃ­a","San BartolomÃ©","Teguise","TÃ­as","Tinajo","Yaiza"]);  
  const p=[...f.pasaPor];shuffle(p);renderPasaPor(p);  
  highlight(f.ref,"orange");  
}  
  
function corregir(){  
  if(modoRepaso)return;  
  const f=preguntas[idx];  
  const sig=municipios.innerText+pasaPor.innerText;  
  if(lastSig[idx]===sig)return;  
  lastSig[idx]=sig;  
  attempts[idx]=(attempts[idx]||0)+1;  
  let error=false;  
  
  document.querySelectorAll("#municipios .item").forEach(d=>{  
    const ok=f.municipios.includes(d.textContent);  
    if(d.classList.contains("sel")!==ok){error=true;d.classList.add("bad");}  
    else d.classList.add("ok");  
  });  


 // ğŸ”— CONEXIONES
document.querySelectorAll("#conecta .item").forEach(d=>{
  const ok = f.conecta.includes(d.textContent);
  if(d.classList.contains("sel") !== ok){
    error = true;
    d.classList.add("bad");
  } else {
    d.classList.add("ok");
  }
});

  
  document.querySelectorAll("#pasaPor .item").forEach((d,i)=>{  
    if(d.textContent!==f.pasaPor[i]){error=true;d.classList.add("bad");}  
    else d.classList.add("ok");  
  });  
  
  if(error){fallos++;highlight(f.ref,"red");}  
  else{  
    correctas++;  
    attempts[idx]===1?(perfectas++,highlight(f.ref,"green")):(conErrores++,highlight(f.ref,"orange"));  
  }  
  actualizar();  
}  
  
function siguiente(){  
  if(modoRepaso)return;  
  idx<preguntas.length-1? (idx++,mostrarPregunta()):mostrarResultados();  
}  
  
function mostrarResultados(){  
  estadisticas.innerHTML=`  
  <h2>ğŸ“Š Resultados</h2>  
  ğŸŸ¢ Correctas: ${correctas}<br>  
  ğŸŸ  Fallos: ${fallos}<br>`;  
  estadisticas.style.display="block";  
}  
  
/* ================= HELPERS ================= */  
function actualizar(){  
  correctasEl.textContent=correctas;  
  fallosEl.textContent=fallos;  
}  
function volver(){location.href="/Territorio/index.html";}  
  
buscador.addEventListener("input", e => {  
  if(!modoRepaso || !baseLayer) return;  
  
  const q = e.target.value.trim().toUpperCase();  
  if(!q){  
    aplicarFiltrosRepaso();  
    return;  
  }  
  
  if(activeLayer){  
    map.removeLayer(activeLayer);  
    activeLayer = null;  
  }  
  
  const buscada = normalizarRef(  
  q.startsWith("LZ") ? q : "LZ-" + q.replace(/\D/g,"")  
);  
  
  baseLayer.eachLayer(l=>{
  const ref = normalizarRef(l.feature.properties.ref);
  if(ref === buscada){
    l.setStyle({ color:"#ff9800", weight:6, opacity:1 });
    map.fitBounds(l.getBounds(), { padding:[20,20] });
    mostrarFicha(ref);
  } else {
    l.setStyle({ opacity:0.15 });
  }
});
});  
  
    
/* ================= EVENTS ================= */  
btnIniciar.onclick=iniciar;  
btnRepaso.onclick = () => {  
  modoRepaso = true;  
  estadisticas.style.display = "none";  
  buscador.style.display = "inline";  
  aplicarFiltrosRepaso();  
};  
  
  
  
btnCorregir.onclick=corregir;  
btnSiguiente.onclick=siguiente;  
  
const correctasEl = document.getElementById("correctas");  
const fallosEl = document.getElementById("fallos");  
  
chkPrim.onchange = aplicarFiltrosRepaso;  
chkSec.onchange  = aplicarFiltrosRepaso;  
chkTer.onchange  = aplicarFiltrosRepaso;  
  
  window.addEventListener("load", () => {  
  entrarRepasoInicial();  
});  
  
</script>  </body>  
</html>  
