<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Juego de carreteras â€“ Lanzarote</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html,body{margin:0;font-family:Arial;background:#0b7}
#top{padding:10px;background:#0a6;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
#contenedor{max-width:820px;margin:16px auto;padding:10px}
.caja{background:white;border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:0 4px 10px rgba(0,0,0,.15)}
.lista{display:flex;flex-wrap:wrap;gap:8px}
.item{padding:6px 10px;border-radius:8px;background:#e6f7f3;cursor:pointer}
.item.sel{box-shadow:inset 0 0 0 2px #0b7}
.item.ok{background:#c8f7c5}
.item.bad{background:#f7c5c5}
.item.miss{background:#eee;color:#666}
.drag{cursor:grab}
#map{height:320px;border-radius:10px}
#buscador{display:none}
.controles{display:flex;gap:10px;justify-content:center}
button{padding:8px 12px;border-radius:8px;border:none;background:#0b7;color:white}
</style>
</head>

<body>

<div id="top">
  <button onclick="iniciarExamen()">ğŸ“ Iniciar examen</button>
  <button onclick="activarRepaso()">ğŸ“– Modo repaso</button>

  <label><input type="checkbox" id="chkPrim" checked> Primarias</label>
  <label><input type="checkbox" id="chkSec" checked> Secundarias</label>
  <label><input type="checkbox" id="chkTer" checked> Terciarias</label>

  <strong>Correctas: <span id="correctas">0</span></strong>
  <strong>Fallos: <span id="fallos">0</span></strong>

  <input id="buscador" placeholder="Buscar carretera (LZ-2)">
</div>

<div id="contenedor">

  <div class="caja">
    <strong id="titulo">â€”</strong>
    <div id="desc"></div>
  </div>

  <div class="caja">
    <strong>ğŸ“ Municipios</strong>
    <div id="municipios" class="lista"></div>
  </div>

  <div class="caja" id="cajaOrden">
    <strong>ğŸ˜ï¸ Pasa por (ordena)</strong>
    <div id="pasaPor" class="lista"></div>
  </div>

  <div class="caja">
    â–¶ Inicio: <span id="inicio">â€”</span><br>
    â¹ Final: <span id="final">â€”</span>
  </div>

  <div class="caja"><div id="map"></div></div>

  <div class="controles">
    <button onclick="corregir()">âœ” Corregir</button>
    <button onclick="siguiente()">Siguiente â¡</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="data_carreteras.js"></script>

<script>
/* ================= MAPA ================= */
const map=L.map("map").setView([28.96,-13.60],11);
L.tileLayer("https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png").addTo(map);

let geoData, capaTodas, capaActiva;

fetch("carreteras_lanzarote_fin.geojson")
.then(r=>r.json()).then(j=>{
  geoData=j;
  activarRepaso();
});

function tiposActivos(){
  return {
    primaria: chkPrim.checked,
    secundaria: chkSec.checked,
    terciaria: chkTer.checked
  };
}

function pintarTodas(){
  if(capaTodas) map.removeLayer(capaTodas);
  const t=tiposActivos();
  capaTodas=L.geoJSON(geoData,{
    filter:f=>t[f.properties.tipo],
    style:{color:"#555",weight:3},
    onEachFeature:(f,l)=>{
      l.on("click",()=>mostrarFicha(f.properties));
    }
  }).addTo(map);
}

function pintarUna(ref,color){
  if(capaActiva) map.removeLayer(capaActiva);
  capaActiva=L.geoJSON(geoData,{
    filter:f=>f.properties.ref===ref,
    style:{color,weight:6}
  }).addTo(map);
}

/* ================= ESTADO ================= */
const MUNICIPIOS=["Arrecife","HarÃ­a","San BartolomÃ©","Teguise","TÃ­as","Tinajo","Yaiza"];
let modo="repaso", preguntas=[], idx=0, corregida=false;
let correctas=0, fallos=0;

/* ================= UI ================= */
function renderMunicipios(sel=[]){
  municipios.innerHTML="";
  MUNICIPIOS.forEach(m=>{
    const d=document.createElement("div");
    d.className="item";
    d.textContent=m;
    if(sel.includes(m)) d.classList.add("sel");
    d.onclick=()=>{ if(modo==="examen") d.classList.toggle("sel"); };
    municipios.appendChild(d);
  });
}

function renderPasaPor(arr){
  pasaPor.innerHTML="";
  arr.forEach(txt=>{
    const d=document.createElement("div");
    d.className="item drag";
    d.textContent=txt;
    d.draggable=true;
    d.ondragstart=e=>e.dataTransfer.setData("t",txt);
    d.ondragover=e=>e.preventDefault();
    d.ondrop=e=>{
      e.preventDefault();
      const src=e.dataTransfer.getData("t");
      const a=[...pasaPor.children].map(x=>x.textContent);
      const i1=a.indexOf(src),i2=a.indexOf(txt);
      [a[i1],a[i2]]=[a[i2],a[i1]];
      renderPasaPor(a);
    };
    pasaPor.appendChild(d);
  });
}

function mostrarFicha(f){
  titulo.textContent=`${f.ref} â€” ${f.nombre||""}`;
  desc.textContent=f.descripcion||"";
  inicio.textContent=f.inicio||"â€”";
  final.textContent=f.final||"â€”";
  renderMunicipios(modo==="repaso"?f.municipios:[]);
  if(modo==="examen"){
    const arr=[...(f.pasaPor||[])].sort(()=>Math.random()-0.5);
    renderPasaPor(arr);
    cajaOrden.style.display="block";
  }else{
    cajaOrden.style.display="none";
  }
  pintarUna(f.ref,"orange");
}

/* ================= EXAMEN ================= */
function iniciarExamen(){
  modo="examen";
  buscador.style.display="none";
  if(capaTodas) map.removeLayer(capaTodas);

  preguntas=Object.entries(dataCarreteras)
    .map(([ref,o])=>({...o,ref}))
    .filter(p=>tiposActivos()[p.tipo]);

  preguntas.sort(()=>Math.random()-0.5);
  idx=0; correctas=0; fallos=0; corregida=false;
  update();
  mostrarFicha(preguntas[0]);
}

function corregir(){
  if(modo!=="examen") return;
  let error=false;
  const f=preguntas[idx];

  document.querySelectorAll("#municipios .item").forEach(el=>{
    el.classList.remove("ok","bad","miss");
    const sel=el.classList.contains("sel");
    const ok=f.municipios.includes(el.textContent);
    if(sel&&ok) el.classList.add("ok");
    else if(sel&&!ok){el.classList.add("bad");error=true;}
    else if(!sel&&ok){el.classList.add("miss");error=true;}
  });

  document.querySelectorAll("#pasaPor .item").forEach((el,i)=>{
    el.classList.remove("ok","bad");
    if(f.pasaPor[i]===el.textContent) el.classList.add("ok");
    else{el.classList.add("bad");error=true;}
  });

  if(error){fallos++;pintarUna(f.ref,"red")}
  else{correctas++;pintarUna(f.ref,"green")}

  corregida=true;
  update();
}

function siguiente(){
  if(!corregida){alert("Debes corregir antes de continuar");return;}
  idx++; corregida=false;
  if(idx>=preguntas.length){alert("Examen terminado");return;}
  mostrarFicha(preguntas[idx]);
}

/* ================= REPASO ================= */
function activarRepaso(){
  modo="repaso";
  buscador.style.display="inline";
  pintarTodas();
  titulo.textContent="Selecciona una carretera en el mapa";
  desc.textContent="";
  renderMunicipios([]);
  cajaOrden.style.display="none";
}

/* ================= FILTROS ================= */
chkPrim.onchange=chkSec.onchange=chkTer.onchange=()=>{
  if(modo==="repaso") pintarTodas();
};

/* ================= BUSCADOR ================= */
buscador.oninput=e=>{
  const r=e.target.value.toUpperCase();
  if(dataCarreteras[r]) mostrarFicha({...dataCarreteras[r],ref:r});
};

function update(){
  correctasSpan.textContent=correctas;
  fallosSpan.textContent=fallos;
}
</script>

</body>
</html>
