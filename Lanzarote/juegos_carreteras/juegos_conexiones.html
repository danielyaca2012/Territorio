<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Juego de conexiones ‚Äì Lanzarote</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html,body{
  margin:0;
  font-family:Arial,Helvetica,sans-serif;
  background:#0b7;
}
#top{
  padding:10px;
  background:#0a6;
  color:#042;
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}
#contenedor{
  max-width:720px;
  margin:20px auto;
}
.caja{
  background:white;
  border-radius:12px;
  padding:15px;
  margin-bottom:12px;
}
.titulo{
  font-weight:bold;
  font-size:1.2rem;
}
.lista{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}
.item{
  padding:6px 10px;
  background:#e6f7f3;
  border-radius:6px;
  cursor:pointer;
}
.item.drag{ cursor:grab; }
.ok{ background:#c8f7c5; }
.bad{ background:#f7c5c5; }
.miss{ background:#eee; }

button{
  padding:8px 12px;
  border-radius:6px;
  border:none;
  cursor:pointer;
  background:#0b7;
  color:white;
}
#map{ height:300px; border-radius:12px; }
.controles{
  display:flex;
  gap:10px;
  justify-content:center;
}
</style>
</head>

<body>

<div id="top">
  <button onclick="iniciar()">üìù Iniciar examen</button>

  <label><input type="checkbox" id="chkPrim" checked> Primarias</label>
  <label><input type="checkbox" id="chkSec" checked> Secundarias</label>
  <label><input type="checkbox" id="chkTer" checked> Terciarias</label>

  <strong>Correctas: <span id="correctas">0</span></strong>
  <strong>Fallos: <span id="fallos">0</span></strong>

  <button style="margin-left:auto" onclick="volver()">‚¨Ö Volver</button>
</div>

<div id="contenedor">

  <div class="caja titulo" id="nombre">‚Äî</div>

  <div class="caja">
    üìç <strong>Municipios (selecciona)</strong>
    <div class="lista" id="municipios"></div>
  </div>

  <div class="caja">
    üèòÔ∏è <strong>Pasa por (ordena)</strong>
    <div class="lista" id="pasaPor"></div>
  </div>

  <div class="caja">
    ‚ñ∂ Inicio: <span id="inicio"></span><br>
    ‚èπ Final: <span id="final"></span>
  </div>

  <div class="caja">
    <div id="map"></div>
  </div>

  <div class="controles">
    <button onclick="corregir()">‚úî Corregir</button>
    <button onclick="siguiente()">Siguiente ‚û°</button>
  </div>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="data_carreteras.js"></script>

<script>
/* ================= MAPA ================= */
const map = L.map("map").setView([28.96,-13.60],11);
L.tileLayer("https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png").addTo(map);

/* ================= VARIABLES ================= */
const TODOS_MUNICIPIOS=[
  "Arrecife","Har√≠a","San Bartolom√©",
  "Teguise","T√≠as","Tinajo","Yaiza"
];

let lista=[], i=0;
let correctas=0, fallos=0;
let corregido=false;
let capas={};
let falloEnPregunta=false;

/* ================= GEOJSON ================= */
fetch("carreteras_lanzarote_fin.geojson")
.then(r=>r.json())
.then(g=>{
  L.geoJSON(g,{
    style:{ color:"#bbb", weight:4 },
    onEachFeature:(f,l)=>{
      if(f.properties.ref) capas[f.properties.ref]=l;
    }
  }).addTo(map);
});

/* ================= UTIL ================= */
function barajar(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
}
function crearMunicipios(){
  const cont=document.getElementById("municipios");
  cont.innerHTML="";
  TODOS_MUNICIPIOS.forEach(m=>{
    const d=document.createElement("div");
    d.className="item";
    d.textContent=m;
    d.onclick=()=>d.classList.toggle("sel");
    cont.appendChild(d);
  });
}
function crearOrden(id,arr){
  const c=document.getElementById(id);
  c.innerHTML="";
  arr.forEach(t=>{
    const d=document.createElement("div");
    d.className="item drag";
    d.textContent=t;
    d.draggable=true;
    d.ondragstart=e=>e.dataTransfer.setData("txt",t);
    d.ondragover=e=>e.preventDefault();
    d.ondrop=e=>{
      e.preventDefault();
      const src=e.dataTransfer.getData("txt");
      const a=[...c.children].map(x=>x.textContent);
      const i1=a.indexOf(src), i2=a.indexOf(t);
      [a[i1],a[i2]]=[a[i2],a[i1]];
      crearOrden(id,a);
    };
    c.appendChild(d);
  });
}

/* ================= MOSTRAR ================= */
function mostrar(){
  const c=lista[i];
  corregido=false;
  falloEnPregunta=false;

  document.getElementById("nombre").textContent=c.ref;
  document.getElementById("inicio").textContent=c.inicio;
  document.getElementById("final").textContent=c.final;

  crearMunicipios();
  crearOrden("pasaPor",[...c.pasaPor].sort(()=>Math.random()-0.5));

  Object.values(capas).forEach(l=>l.setStyle({color:"#bbb",weight:4}));
  capas[c.ref]?.setStyle({color:"orange",weight:7});
  map.fitBounds(capas[c.ref].getBounds());
}

/* ================= EXAMEN ================= */
function iniciar(){
  lista=Object.values(dataCarreteras);
  barajar(lista);
  i=0; correctas=0; fallos=0;
  actualizar(); mostrar();
}

/* ================= CORREGIR ================= */
function corregir(){
  if(corregido) return;
  const c=lista[i];

  // MUNICIPIOS
  document.querySelectorAll("#municipios .item").forEach(d=>{
    const ok=c.municipios.includes(d.textContent);
    const sel=d.classList.contains("sel");
    if(sel && ok) d.classList.add("ok");
    else if(sel && !ok){ d.classList.add("bad"); falloEnPregunta=true; }
    else if(!sel && ok){ d.classList.add("miss"); falloEnPregunta=true; }
  });

  // PASA POR
  [...document.querySelectorAll("#pasaPor .item")].forEach((d,idx)=>{
    if(d.textContent===c.pasaPor[idx]) d.classList.add("ok");
    else{ d.classList.add("bad"); falloEnPregunta=true; }
  });

  if(falloEnPregunta) fallos++;
  else correctas++;

  corregido=true;
  actualizar();
}

/* ================= SIGUIENTE ================= */
function siguiente(){
  if(!corregido){ alert("Primero corrige"); return; }
  if(i<lista.length-1){ i++; mostrar(); }
}

/* ================= UI ================= */
function actualizar(){
  correctasSpan.textContent=correctas;
  fallosSpan.textContent=fallos;
}
function volver(){
  window.location.href="/Territorio/index.html";
}

/* ================= INICIO ================= */
iniciar();
</script>

</body>
</html>
