<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Juego de conexiones ‚Äì Lanzarote</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html,body{
  margin:0;
  font-family:Arial;
  background:linear-gradient(135deg,#0b7,#0a5);
}

#top{
  padding:10px;
  background:#0b7;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
}

#contenedor{
  max-width:760px;
  margin:auto;
  padding:15px;
}

.caja{
  background:white;
  padding:15px;
  margin-bottom:12px;
  border-radius:12px;
  box-shadow:0 4px 10px rgba(0,0,0,.15);
}

h2{margin:0}

.lista{
  list-style:none;
  padding:0;
}

.lista li{
  background:#eef;
  margin:5px 0;
  padding:6px 10px;
  border-radius:6px;
  display:flex;
  justify-content:space-between;
}

button{
  padding:6px 10px;
  border:none;
  border-radius:6px;
  background:#0b7;
  color:white;
  cursor:pointer;
}

button:hover{background:#099}

#map{
  height:260px;
  border-radius:12px;
}

.correcto{color:green;font-weight:bold}
.incorrecto{color:red;font-weight:bold}
</style>
</head>

<body>

<div id="top">
  <button onclick="iniciar()">üìù Iniciar examen</button>

  <label><input type="checkbox" id="chkPrim" checked> Primarias</label>
  <label><input type="checkbox" id="chkSec" checked> Secundarias</label>
  <label><input type="checkbox" id="chkTer" checked> Terciarias</label>

  <span id="estado">‚Äî</span>
  <span id="puntos">Puntos: 0</span>
  <span id="fallos">Fallos: 0</span>

  <button style="margin-left:auto" onclick="volver()">‚¨Ö Volver</button>
</div>

<div id="contenedor">

  <div class="caja">
    <h2 id="titulo">‚Äî</h2>
    <p id="descripcion"></p>
  </div>

  <div class="caja">
    üìç <strong>Municipios (ordena)</strong>
    <ul id="municipios" class="lista"></ul>
  </div>

  <div class="caja">
    üèòÔ∏è <strong>Pasa por (ordena)</strong>
    <ul id="pasaPor" class="lista"></ul>
  </div>

  <div class="caja">
    ‚ñ∂ <strong>Inicio:</strong> <span id="inicio"></span><br>
    ‚èπ <strong>Final:</strong> <span id="final"></span>
  </div>

  <div class="caja">
    <div id="map"></div>
  </div>

  <div style="text-align:center">
    <button onclick="corregir()">‚úî Corregir</button>
    <button onclick="siguiente()">Siguiente ‚û°</button>
  </div>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="data_carreteras.js"></script>

<script>
/* ================= MAPA ================= */
const map=L.map("map").setView([28.96,-13.6],11);
L.tileLayer(
  "https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png"
).addTo(map);

let geoData,capa;

/* ================= ESTADO ================= */
let lista=[];
let i=0,puntos=0,fallos=0;

/* ================= GEOJSON ================= */
fetch("carreteras_lanzarote_fin.geojson")
.then(r=>r.json())
.then(d=>geoData=d);

/* ================= UTIL ================= */
function tipo(ref){
  const n=parseInt(ref.replace("LZ-",""));
  if([1,2,3].includes(n))return"primaria";
  if(n>=10&&n<=67)return"secundaria";
  return"terciaria";
}

function barajar(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
}

/* ================= INICIO ================= */
function iniciar(){
  const usar=[];
  if(chkPrim.checked)usar.push("primaria");
  if(chkSec.checked)usar.push("secundaria");
  if(chkTer.checked)usar.push("terciaria");

  lista=Object.values(dataCarreteras)
    .filter(c=>usar.includes(c.tipo));

  if(lista.length===0){
    alert("Selecciona al menos una categor√≠a");
    return;
  }

  barajar(lista);
  i=0;puntos=0;fallos=0;
  actualizar();
  mostrar();
}

/* ================= MOSTRAR ================= */
function mostrar(){
  const c=lista[i];
  estado.textContent=`${i+1}/${lista.length}`;
  titulo.textContent=c.nombre;
  descripcion.textContent=c.descripcion;
  inicio.textContent=c.inicio;
  final.textContent=c.final;

  pintarLista("municipios",c.municipios);
  pintarLista("pasaPor",c.pasaPor);
  dibujar(c.nombre);
}

function pintarLista(id,arr){
  const ul=document.getElementById(id);
  ul.innerHTML="";
  const copia=[...arr];
  barajar(copia);

  copia.forEach((t,idx)=>{
    const li=document.createElement("li");
    li.textContent=t;

    const ctr=document.createElement("span");
    ctr.innerHTML=`
      <button onclick="mover(this,-1)">‚ñ≤</button>
      <button onclick="mover(this,1)">‚ñº</button>
    `;
    li.appendChild(ctr);
    ul.appendChild(li);
  });
}

function mover(btn,dir){
  const li=btn.closest("li");
  const ul=li.parentNode;
  const idx=[...ul.children].indexOf(li);
  const nuevo=idx+dir;
  if(nuevo<0||nuevo>=ul.children.length)return;
  ul.insertBefore(li,ul.children[nuevo+(dir>0?1:0)]);
}

/* ================= CORRECCI√ìN ================= */
function leer(id){
  return [...document.getElementById(id).children]
    .map(li=>li.firstChild.textContent);
}

function corregir(){
  const c=lista[i];
  const ok1=JSON.stringify(leer("municipios"))===JSON.stringify(c.municipios);
  const ok2=JSON.stringify(leer("pasaPor"))===JSON.stringify(c.pasaPor);

  if(ok1&&ok2){
    puntos++;
    pintar("green");
  }else{
    fallos++;
    pintar("red");
  }
  actualizar();
}

function actualizar(){
  puntosSpan.textContent=`Puntos: ${puntos}`;
  fallosSpan.textContent=`Fallos: ${fallos}`;
}

/* ================= MAPA ================= */
function dibujar(ref){
  if(capa)map.removeLayer(capa);
  capa=L.geoJSON(geoData,{
    filter:f=>f.properties.ref===ref,
    style:{color:"blue",weight:6}
  }).addTo(map);
  map.fitBounds(capa.getBounds(),{padding:[20,20]});
}

function pintar(color){
  capa.setStyle({color,weight:7});
}

/* ================= NAVEGACI√ìN ================= */
function siguiente(){
  if(i<lista.length-1){i++;mostrar();}
}

function volver(){
  location.href="/Territorio/index.html";
}
</script>

</body>
</html>
