<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Juego de conexiones ‚Äì Lanzarote</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html,body{
  margin:0;
  font-family:Arial,Helvetica,sans-serif;
  background:#0b7;
}
#top{
  padding:10px;
  background:#0a6;
  color:#042;
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}
#contenedor{ max-width:820px; margin:18px auto; padding:10px; }
.caja{
  background:white;
  border-radius:12px;
  padding:14px;
  margin-bottom:12px;
  box-shadow:0 4px 10px rgba(0,0,0,0.12);
}
.titulo{ font-weight:700; font-size:1.1rem; margin-bottom:8px; }
.lista{ display:flex; flex-wrap:wrap; gap:8px; }
.item{
  padding:6px 10px;
  border-radius:8px;
  background:#e6f7f3;
  cursor:pointer;
  user-select:none;
}
.item.sel{ box-shadow:inset 0 0 0 2px #0b7; background:#d1f0e6; }
.item.ok{ background:#c8f7c5; }
.item.bad{ background:#f7c5c5; }
.item.miss{ background:#f0f0f0; color:#666; }
.drag{ cursor:grab; }

button{
  padding:8px 12px;
  border-radius:8px;
  border:none;
  background:#0b7;
  color:white;
  cursor:pointer;
}
button:hover{ background:#099; }

#map{ height:320px; border-radius:10px; overflow:hidden; }
.controles{ display:flex; gap:10px; justify-content:center; margin-top:6px; }

#estadisticas{
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:rgba(0,0,0,0.8);
  color:white;
  padding:30px 40px;
  border-radius:14px;
  display:none;
  z-index:2000;
  text-align:center;
  font-size:1.1rem;
}

@media (max-width:640px){ #contenedor{ padding:8px; } }
</style>
</head>

<body>

<div id="top">
  <button id="btnIniciar">üìù Iniciar examen</button>

  <label><input type="checkbox" id="chkPrim" checked> Primarias</label>
  <label><input type="checkbox" id="chkSec" checked> Secundarias</label>
  <label><input type="checkbox" id="chkTer" checked> Terciarias</label>

  <strong>Correctas: <span id="correctas">0</span></strong>
  <strong>Fallos: <span id="fallos">0</span></strong>

  <button style="margin-left:auto" onclick="volver()">‚¨Ö Volver</button>
</div>

<div id="contenedor">

  <div class="caja">
    <div id="tituloFicha" class="titulo">‚Äî</div>
    <div id="descFicha"></div>
  </div>

  <div class="caja">
    <strong>üìç Municipios</strong>
    <div id="municipios" class="lista"></div>
  </div>

  <div class="caja">
    <strong>üèòÔ∏è Pasa por (ordena)</strong>
    <div id="pasaPor" class="lista"></div>
  </div>

  <div class="caja">
    ‚ñ∂ Inicio: <span id="inicio">‚Äî</span><br>
    ‚èπ Final: <span id="final">‚Äî</span>
  </div>

  <div class="caja"><div id="map"></div></div>

  <div class="controles">
    <button id="btnCorregir">‚úî Corregir</button>
    <button id="btnSiguiente">Siguiente ‚û°</button>
  </div>

</div>

<div id="estadisticas"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="data_carreteras.js"></script>

<script>
/* ================= MAPA ================= */
const map = L.map("map").setView([28.96, -13.60], 11);
L.tileLayer("https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png").addTo(map);

let geoData=null, activeLayer=null;

fetch("carreteras_lanzarote_fin.geojson")
  .then(r=>r.json())
  .then(j=>geoData=j);

/* ================= ESTADO ================= */
const TODOS_MUNICIPIOS=["Arrecife","Har√≠a","San Bartolom√©","Teguise","T√≠as","Tinajo","Yaiza"];
let preguntas=[], idx=0;
let correctas=0, fallos=0;
let perfectas=0, conErrores=0;
let attempts={}, lastSig={};

/* ================= UTIL ================= */
function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
}
function tipoCarreteraFromRef(ref){
  const n=parseInt(ref.replace(/\D/g,""));
  if([1,2,3].includes(n))return"primaria";
  if(n>=10&&n<=67)return"secundaria";
  return"terciaria";
}

/* ================= MAP HIGHLIGHT ================= */
function highlight(ref,color){
  if(activeLayer) map.removeLayer(activeLayer);
  if(!geoData){ setTimeout(()=>highlight(ref,color),200); return; }
  activeLayer=L.geoJSON(geoData,{
    filter:f=>String(f.properties.ref)===String(ref),
    style:{color,weight:6}
  }).addTo(map);
  map.fitBounds(activeLayer.getBounds(),{padding:[20,20]});
}

/* ================= UI ================= */
function renderMunicipios(){
  const c=document.getElementById("municipios"); c.innerHTML="";
  TODOS_MUNICIPIOS.forEach(m=>{
    const d=document.createElement("div");
    d.className="item";
    d.textContent=m;
    d.onclick=()=>d.classList.toggle("sel");
    c.appendChild(d);
  });
}
function renderPasaPor(arr){
  const c=document.getElementById("pasaPor"); c.innerHTML="";
  arr.forEach(t=>{
    const d=document.createElement("div");
    d.className="item drag";
    d.textContent=t;
    d.draggable=true;
    d.ondragstart=e=>e.dataTransfer.setData("t",t);
    d.ondragover=e=>e.preventDefault();
    d.ondrop=e=>{
      e.preventDefault();
      const s=e.dataTransfer.getData("t");
      const a=[...c.children].map(x=>x.textContent);
      const i1=a.indexOf(s), i2=a.indexOf(t);
      [a[i1],a[i2]]=[a[i2],a[i1]];
      renderPasaPor(a);
    };
    c.appendChild(d);
  });
}

/* ================= EXAMEN ================= */
function mostrar(){
  const f=preguntas[idx];
  document.getElementById("tituloFicha").textContent=f.ref;
  document.getElementById("descFicha").textContent=f.descripcion||"";
  document.getElementById("inicio").textContent=f.inicio||"‚Äî";
  document.getElementById("final").textContent=f.final||"‚Äî";
  renderMunicipios();
  const p=[...f.pasaPor]; shuffle(p); renderPasaPor(p);
  highlight(f.ref,"orange");
}

function iniciar(){
  preguntas=Object.entries(dataCarreteras).map(([r,o])=>{
    o.ref=r; o.tipo=o.tipo||tipoCarreteraFromRef(r); return o;
  }).filter(o=>
    (chkPrim.checked&&o.tipo==="primaria")||
    (chkSec.checked&&o.tipo==="secundaria")||
    (chkTer.checked&&o.tipo==="terciaria")
  );
  shuffle(preguntas);
  idx=0; correctas=fallos=perfectas=conErrores=0;
  attempts={}; lastSig={};
  actualizar();
  mostrar();
}

function corregir(){
  const f=preguntas[idx];
  const sig=document.querySelector("#municipios").innerText+
            document.querySelector("#pasaPor").innerText;
  if(lastSig[idx]===sig)return;
  lastSig[idx]=sig;
  attempts[idx]=(attempts[idx]||0)+1;

  let error=false;

  document.querySelectorAll("#municipios .item").forEach(d=>{
    const ok=f.municipios.includes(d.textContent);
    if(d.classList.contains("sel")!==ok){ error=true; d.classList.add("bad"); }
    else d.classList.add("ok");
  });

  document.querySelectorAll("#pasaPor .item").forEach((d,i)=>{
    if(d.textContent!==f.pasaPor[i]){ error=true; d.classList.add("bad"); }
    else d.classList.add("ok");
  });

  if(error){
    fallos++;
    highlight(f.ref,"red");
  }else{
    correctas++;
    if(attempts[idx]===1){ perfectas++; highlight(f.ref,"green"); }
    else{ conErrores++; highlight(f.ref,"orange"); }
  }
  actualizar();
}

function siguiente(){
  if(idx<preguntas.length-1){ idx++; mostrar(); }
  else mostrarResultados();
}

function mostrarResultados(){
  estadisticas.innerHTML=`
    <h2>üìä Resultados</h2>
    ‚úî Correctas: ${correctas}<br>
    ‚ùå Fallos: ${fallos}<br><br>
    üü¢ Perfectas: ${perfectas}<br>
    üü† Con errores: ${conErrores}
  `;
  estadisticas.style.display="block";
}

function actualizar(){
  correctasEl.textContent=correctas;
  fallosEl.textContent=fallos;
}

function volver(){ location.href="/Territorio/index.html"; }

/* ================= EVENTS ================= */
btnIniciar.onclick=iniciar;
btnCorregir.onclick=corregir;
btnSiguiente.onclick=siguiente;

const correctasEl=document.getElementById("correctas");
const fallosEl=document.getElementById("fallos");
</script>

</body>
</html>
