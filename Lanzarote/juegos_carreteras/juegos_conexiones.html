<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Juego de conexiones â€“ Lanzarote</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html,body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#0b7;}
#top{
  padding:10px;background:#0a6;color:#042;
  display:flex;gap:10px;align-items:center;flex-wrap:wrap;
}
#contenedor{max-width:820px;margin:18px auto;padding:10px;}
.caja{background:white;border-radius:12px;padding:14px;margin-bottom:12px;
box-shadow:0 4px 10px rgba(0,0,0,.12);}
.titulo{font-weight:700;font-size:1.1rem;margin-bottom:8px;}
.lista{display:flex;flex-wrap:wrap;gap:8px;}
.item{padding:6px 10px;border-radius:8px;background:#e6f7f3;cursor:pointer;}
.item.sel{box-shadow:inset 0 0 0 2px #0b7;background:#d1f0e6;}
.item.ok{background:#c8f7c5;}
.item.bad{background:#f7c5c5;}
.item.miss{background:#eee;color:#666;}
.drag{cursor:grab;}
button{padding:8px 12px;border-radius:8px;border:none;background:#0b7;color:white;cursor:pointer;}
button:hover{background:#099;}
#map{height:320px;border-radius:10px;}
.controles{display:flex;gap:10px;justify-content:center;}

#estadisticas{
  position:fixed;top:50%;left:50%;
  transform:translate(-50%,-50%);
  background:rgba(0,0,0,.8);color:white;
  padding:30px 40px;border-radius:14px;
  display:none;z-index:2000;text-align:center;
}
</style>
</head>

<body>

<div id="top">
  <button id="btnIniciar">ğŸ“ Iniciar examen</button>
  <button id="btnRepaso">ğŸ“– Modo repaso</button>

  <label><input type="checkbox" id="chkPrim" checked> Primarias</label>
  <label><input type="checkbox" id="chkSec" checked> Secundarias</label>
  <label><input type="checkbox" id="chkTer" checked> Terciarias</label>

  <strong>Correctas: <span id="correctas">0</span></strong>
  <strong>Fallos: <span id="fallos">0</span></strong>

  <button style="margin-left:auto" onclick="volver()">â¬… Volver</button>
</div>

<div id="contenedor">

<div class="caja">
  <div id="tituloFicha" class="titulo">â€”</div>
  <div id="descFicha"></div>
</div>

<div class="caja">
  <strong>ğŸ“ Municipios</strong>
  <div id="municipios" class="lista"></div>
</div>

<div class="caja">
  <strong>ğŸ˜ï¸ Pasa por</strong>
  <div id="pasaPor" class="lista"></div>
</div>

<div class="caja">
  â–¶ Inicio: <span id="inicio">â€”</span><br>
  â¹ Final: <span id="final">â€”</span>
</div>

<div class="caja"><div id="map"></div></div>

<div class="controles">
  <button id="btnCorregir">âœ” Corregir</button>
  <button id="btnSiguiente">Siguiente â¡</button>
</div>

</div>

<div id="estadisticas"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="data_carreteras.js"></script>

<script>
/* ================= MAPA ================= */
const map=L.map("map").setView([28.96,-13.60],11);
L.tileLayer("https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png").addTo(map);

let geoData, baseLayer, activeLayer;
let modoRepaso=true;

/* ================= GEOJSON ================= */
fetch("carreteras_lanzarote_fin.geojson")
.then(r=>r.json())
.then(j=>{
  geoData=j;
  baseLayer=L.geoJSON(geoData,{
    style:{color:"#3388ff",weight:4},
    onEachFeature:(f,l)=>{
      l.on("click",()=>modoRepaso && mostrarFicha(f.properties.ref));
    }
  }).addTo(map);
});

/* ================= ESTADO ================= */
let preguntas=[],idx=0;
let correctas=0,fallos=0;
let perfectas=0,conErrores=0;
let attempts={},lastSig={};

/* ================= UTIL ================= */
function tipo(ref){
  const n=parseInt(ref.replace(/\D/g,""));
  if([1,2,3].includes(n))return"primaria";
  if(n>=10&&n<=67)return"secundaria";
  return"terciaria";
}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}}

/* ================= MAP ================= */
function highlight(ref,color){
  if(activeLayer) map.removeLayer(activeLayer);
  activeLayer=L.geoJSON(geoData,{
    filter:f=>f.properties.ref===ref,
    style:{color,weight:6}
  }).addTo(map);
  map.fitBounds(activeLayer.getBounds(),{padding:[20,20]});
}

/* ================= UI ================= */
function renderMunicipios(arr=[],sel=[]){
  const c=municipios;c.innerHTML="";
  arr.forEach(m=>{
    const d=document.createElement("div");
    d.className="item";d.textContent=m;
    if(sel.includes(m))d.classList.add("sel");
    d.onclick=()=>!modoRepaso&&d.classList.toggle("sel");
    c.appendChild(d);
  });
}
function renderPasaPor(arr){
  pasaPor.innerHTML="";
  arr.forEach(t=>{
    const d=document.createElement("div");
    d.className="item"+(modoRepaso?"":" drag");
    d.textContent=t;
    if(!modoRepaso){
      d.draggable=true;
      d.ondragstart=e=>e.dataTransfer.setData("t",t);
      d.ondragover=e=>e.preventDefault();
      d.ondrop=e=>{
        e.preventDefault();
        const s=e.dataTransfer.getData("t");
        const a=[...pasaPor.children].map(x=>x.textContent);
        const i1=a.indexOf(s),i2=a.indexOf(t);
        [a[i1],a[i2]]=[a[i2],a[i1]];
        renderPasaPor(a);
      };
    }
    pasaPor.appendChild(d);
  });
}

/* ================= REPASO ================= */
function mostrarFicha(ref){
  const f=dataCarreteras[ref];
  if(!f)return;
  tituloFicha.textContent=ref;
  descFicha.textContent=f.descripcion||"";
  inicio.textContent=f.inicio||"â€”";
  final.textContent=f.final||"â€”";
  renderMunicipios(f.municipios||[]);
  renderPasaPor(f.pasaPor||[]);
  highlight(ref,"orange");
}

/* ================= EXAMEN ================= */
function iniciar(){
  estadisticas.style.display="none";
  modoRepaso=false;

  preguntas=Object.entries(dataCarreteras)
    .map(([r,o])=>({...o,ref:r,tipo:o.tipo||tipo(r)}))
    .filter(o=>
      (chkPrim.checked&&o.tipo==="primaria")||
      (chkSec.checked&&o.tipo==="secundaria")||
      (chkTer.checked&&o.tipo==="terciaria")
    );
  shuffle(preguntas);
  idx=0;correctas=fallos=perfectas=conErrores=0;
  attempts={};lastSig={};
  actualizar();
  mostrarPregunta();
}

function mostrarPregunta(){
  const f=preguntas[idx];
  tituloFicha.textContent=f.ref;
  descFicha.textContent=f.descripcion||"";
  inicio.textContent=f.inicio||"â€”";
  final.textContent=f.final||"â€”";
  renderMunicipios(["Arrecife","HarÃ­a","San BartolomÃ©","Teguise","TÃ­as","Tinajo","Yaiza"]);
  const p=[...f.pasaPor];shuffle(p);renderPasaPor(p);
  highlight(f.ref,"orange");
}

function corregir(){
  if(modoRepaso)return;
  const f=preguntas[idx];
  const sig=municipios.innerText+pasaPor.innerText;
  if(lastSig[idx]===sig)return;
  lastSig[idx]=sig;
  attempts[idx]=(attempts[idx]||0)+1;
  let error=false;

  document.querySelectorAll("#municipios .item").forEach(d=>{
    const ok=f.municipios.includes(d.textContent);
    if(d.classList.contains("sel")!==ok){error=true;d.classList.add("bad");}
    else d.classList.add("ok");
  });

  document.querySelectorAll("#pasaPor .item").forEach((d,i)=>{
    if(d.textContent!==f.pasaPor[i]){error=true;d.classList.add("bad");}
    else d.classList.add("ok");
  });

  if(error){fallos++;highlight(f.ref,"red");}
  else{
    correctas++;
    attempts[idx]===1?(perfectas++,highlight(f.ref,"green")):(conErrores++,highlight(f.ref,"orange"));
  }
  actualizar();
}

function siguiente(){
  if(modoRepaso)return;
  idx<preguntas.length-1? (idx++,mostrarPregunta()):mostrarResultados();
}

function mostrarResultados(){
  estadisticas.innerHTML=`
  <h2>ğŸ“Š Resultados</h2>
  ğŸŸ¢ Correctas: ${correctas}<br>
  ğŸŸ  Fallos: ${fallos}<br>`;
  estadisticas.style.display="block";
}

/* ================= HELPERS ================= */
function actualizar(){
  correctasEl.textContent=correctas;
  fallosEl.textContent=fallos;
}
function volver(){location.href="/Territorio/index.html";}

/* ================= EVENTS ================= */
btnIniciar.onclick=iniciar;
btnRepaso.onclick = () => {
  modoRepaso = true;

  // ocultar resultados si estaban visibles
  estadisticas.style.display = "none";
};

btnCorregir.onclick=corregir;
btnSiguiente.onclick=siguiente;

const correctasEl = document.getElementById("correctas");
const fallosEl = document.getElementById("fallos");

</script>

</body>
</html>
