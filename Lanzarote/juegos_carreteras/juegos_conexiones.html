<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Juego de conexiones ‚Äì Lanzarote</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html,body{
  margin:0;
  font-family:Arial,Helvetica,sans-serif;
  background:#0b7;
}
#top{
  padding:10px;
  background:#0a6;
  color:#042;
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}
#contenedor{
  max-width:700px;
  margin:20px auto;
}
.caja{
  background:white;
  border-radius:12px;
  padding:15px;
  margin-bottom:12px;
}
.titulo{
  font-weight:bold;
  font-size:1.2rem;
}
.lista{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}
.item{
  padding:6px 10px;
  background:#e6f7f3;
  border-radius:6px;
  cursor:grab;
}
button{
  padding:8px 12px;
  border-radius:6px;
  border:none;
  cursor:pointer;
  background:#0b7;
  color:white;
}
button:hover{ background:#099; }
#map{ height:300px; border-radius:12px; }
.controles{
  display:flex;
  gap:10px;
  justify-content:center;
}
</style>
</head>

<body>

<div id="top">
  <button onclick="iniciar()">üìù Iniciar examen</button>

  <label><input type="checkbox" id="chkPrim" checked> Primarias</label>
  <label><input type="checkbox" id="chkSec" checked> Secundarias</label>
  <label><input type="checkbox" id="chkTer" checked> Terciarias</label>

  <strong>Puntos: <span id="puntos">0</span></strong>
  <strong>Fallos: <span id="fallos">0</span></strong>

  <button style="margin-left:auto" onclick="volver()">‚¨Ö Volver</button>
</div>

<div id="contenedor">

  <div class="caja titulo" id="nombre">‚Äî</div>

  <div class="caja">
    üìç <strong>Municipios (ordena)</strong>
    <div class="lista" id="municipios"></div>
  </div>

  <div class="caja">
    üèòÔ∏è <strong>Pasa por (ordena)</strong>
    <div class="lista" id="pasaPor"></div>
  </div>

  <div class="caja">
    ‚ñ∂ Inicio: <span id="inicio"></span><br>
    ‚èπ Final: <span id="final"></span>
  </div>

  <div class="caja">
    <div id="map"></div>
  </div>

  <div class="controles">
    <button onclick="corregir()">‚úî Corregir</button>
    <button onclick="siguiente()">Siguiente ‚û°</button>
  </div>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="data_carreteras.js"></script>

<script>
/* ================= MAPA ================= */
const map = L.map("map").setView([28.96,-13.60],11);
L.tileLayer("https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png").addTo(map);

/* ================= VARIABLES ================= */
let lista=[], i=0;
let puntos=0, fallos=0;
let modo="repaso";
let corregido=false;
let capas={};

/* ================= CARGA GEOJSON ================= */
fetch("carreteras_lanzarote_fin.geojson")
.then(r=>r.json())
.then(g=>{
  L.geoJSON(g,{
    style:{ color:"#bbb", weight:4 },
    onEachFeature:(f,l)=>{
      if(f.properties.ref){
        capas[f.properties.ref]=l;
      }
    }
  }).addTo(map);
});

/* ================= UTIL ================= */
function barajar(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
}
function crearLista(id,arr){
  const cont=document.getElementById(id);
  cont.innerHTML="";
  arr.forEach(t=>{
    const d=document.createElement("div");
    d.className="item";
    d.textContent=t;
    d.draggable=true;
    d.ondragstart=e=>e.dataTransfer.setData("txt",t);
    d.ondragover=e=>e.preventDefault();
    d.ondrop=e=>{
      e.preventDefault();
      const src=e.dataTransfer.getData("txt");
      const a=[...cont.children].map(x=>x.textContent);
      const i1=a.indexOf(src), i2=a.indexOf(t);
      [a[i1],a[i2]]=[a[i2],a[i1]];
      crearLista(id,a);
    };
    cont.appendChild(d);
  });
}

/* ================= MOSTRAR ================= */
function mostrar(){
  const c=lista[i];
  document.getElementById("nombre").textContent=c.nombre+" ("+c.ref+")";
  document.getElementById("inicio").textContent=c.inicio;
  document.getElementById("final").textContent=c.final;

  crearLista("municipios",[...c.municipios].sort(()=>Math.random()-0.5));
  crearLista("pasaPor",[...c.pasaPor].sort(()=>Math.random()-0.5));

  Object.values(capas).forEach(l=>l.setStyle({color:"#bbb",weight:4}));
  if(capas[c.ref]){
    capas[c.ref].setStyle({color:"orange",weight:7});
    map.fitBounds(capas[c.ref].getBounds());
  }
}

/* ================= EXAMEN ================= */
function iniciar(){
  const usar=[];
  if(chkPrim.checked) usar.push("primaria");
  if(chkSec.checked) usar.push("secundaria");
  if(chkTer.checked) usar.push("terciaria");

  lista=Object.values(dataCarreteras).filter(c=>usar.includes(c.tipo));
  if(!lista.length){ alert("Selecciona categor√≠as"); return; }

  barajar(lista);
  i=0; puntos=0; fallos=0;
  modo="examen"; corregido=false;
  actualizar(); mostrar();
}

/* ================= CORREGIR ================= */
function corregir(){
  if(modo!=="examen") return;

  const c=lista[i];
  const m=[...document.querySelectorAll("#municipios .item")].map(x=>x.textContent);
  const p=[...document.querySelectorAll("#pasaPor .item")].map(x=>x.textContent);

  const ok1=JSON.stringify(m)===JSON.stringify(c.municipios);
  const ok2=JSON.stringify(p)===JSON.stringify(c.pasaPor);

  if(ok1 && ok2){
    puntos++;
    capas[c.ref]?.setStyle({color:"green"});
  }else{
    fallos++;
    capas[c.ref]?.setStyle({color:"red"});
  }
  corregido=true;
  actualizar();
}

/* ================= SIGUIENTE ================= */
function siguiente(){
  if(modo==="examen" && !corregido){
    alert("Primero corrige");
    return;
  }
  if(i<lista.length-1){
    i++; corregido=false; mostrar();
  }
}

/* ================= UI ================= */
function actualizar(){
  puntosSpan.textContent=puntos;
  fallosSpan.textContent=fallos;
}
function volver(){
  window.location.href="/Territorio/index.html";
}

/* ================= INICIO REPASO ================= */
lista=Object.values(dataCarreteras);
mostrar();
</script>

</body>
</html>
