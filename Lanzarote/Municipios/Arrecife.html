<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Juego de nÃºcleos â€“ Arrecife</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
  html, body {
    height: 100%;
    margin: 0;
    font-family: Arial, Helvetica, sans-serif;
  }

  #top {
    height: 56px;
    padding: 10px;
    background: #0b7;
    color: #042;
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
    box-sizing: border-box;
  }

  #map {
    height: calc(100vh - 56px);
    width: 100%;
  }
.boton-volver {
  margin-left: auto;           /* lo empuja a la derecha */
  background: #fff;
  color: #042;
  font-weight: bold;
}
  .boton-volver:hover {
  background: #e6f7f3;
}
  button {
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px solid #999;
    cursor: pointer;
  }

  #nucleo {
    font-weight: bold;
    font-size: 1.2rem;
  }

  #mensaje, #estadisticas {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.75);
    color: white;
    padding: 25px 35px;
    border-radius: 12px;
    display: none;
    z-index: 1000;
    text-align: center;
  }

  #mensaje {
    font-size: 3rem;
  }

  #estadisticas h2 {
    margin-top: 0;
  }
</style>
</head>
<body>

<div id="top">
  <button id="start">Iniciar</button>
  <button id="repaso">Modo repaso</button>
  <span id="progreso">â€”/â€”</span>
  <span id="nucleo">â€”</span>
  <span id="info"></span>
  <span id="fallos">Fallos: 0</span>
   <button class="boton-volver" onclick="volverInicio()">â¬… Volver al menÃº principal</button>
</div>

<div id="mensaje"></div>
<div id="estadisticas"></div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// =====================
// NÃºcleos
// =====================
const nucleos = [
  {name:"Casco de Arrecife", lat:28.959490, lng:-13.548368, umbral:50},
  {name:"Argana Alta", lat:28.979348, lng:-13.569044, umbral:50},
  {name:"Argana Baja", lat:28.970563, lng:-13.566735, umbral:50},
  {name:"Maneje", lat:28.976457, lng:-13.556657, umbral:50},
  {name:"Altavista", lat:28.973350, lng:-13.548784, umbral:50},
  {name:"Titerroy", lat:28.970694, lng:-13.557025, umbral:50},
  {name:"Valterra", lat:28.965813, lng:-13.546413, umbral:50},
  {name:"El Cable", lat:28.956898, lng:-13.571711, umbral:50},
  {name:"La Concha", lat:28.955777, lng:-13.583071, umbral:50},
  {name:"San Francisco Javier", lat:28.963540, lng:-13.565440, umbral:50},
  {name:"Tenorio", lat:28.974964, lng:-13.540992, umbral:50},
  {name:"Los Alonso", lat:28.969547, lng:-13.545010, umbral:50},
  {name:"Las Salinas", lat:28.960836, lng:-13.559475, umbral:50},
  {name:"La Vega", lat:28.964412, lng:-13.557413, umbral:50},
  {name:"Parque Maneje", lat:28.978453, lng:-13.555087, umbral:50},
  {name:"Consorcio de Seguridad, Emergencias, Salvamento, PrevenciÃ³n y ExtinciÃ³n de Incendios de Lanzarote", lat:28.977540, lng:-13.563266, umbral:50},
  {name:"Aeropuerto de Lanzarote", lat:28.952350, lng:-13.607401, umbral:50},
  {name:"Playa Honda", lat:28.950533, lng:-13.591650, umbral:50},
  {name:"Charco de San GinÃ©s", lat:28.961327, lng:-13.546891, umbral:50},
  {name:"Playa del Reducto", lat:28.958049, lng:-13.559759, umbral:50},
  {name:"Puerto de Arrecife", lat:28.965512, lng:-13.534364, umbral:50},
  {name:"Playa de la Arena", lat:28.973429, lng:-13.531598, umbral:50},
  {name:"Hospital Molina Orosa", lat:28.973868, lng:-13.566331, umbral:50},
  {name:"Hospital Insular", lat:28.963229, lng:-13.543426, umbral:50}
];

// =====================
let map = L.map('map').setView([28.961161,-13.546479], 14);

L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png')
  .addTo(map);

// ðŸ”§ Forzar cÃ¡lculo correcto del tamaÃ±o
setTimeout(() => {
  map.invalidateSize();
}, 200);

let order=[], index=0, zonas=[];
let fallosTotales=0, fallosActual=0;
let aciertoActual=false;
let juegoTerminado=false;
let modoRepaso=false;

// =====================
function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

function mostrarMensaje(txt,tipo){
  const m=document.getElementById("mensaje");
  m.textContent=txt;
  m.style.display="block";
  setTimeout(()=>{
    m.style.display="none";
    if(tipo==="ok"){ index++; nextRound(); }
  },900);
}

// =====================
// BOTONES
// =====================
document.getElementById("start").onclick=()=>{
  modoRepaso=false;
  juegoTerminado=false;
  document.getElementById("estadisticas").style.display="none";
  nucleos.forEach(n=>delete n.colorAcertado);
  clearMap();
  order=shuffle([...nucleos]);
  index=0;
  fallosTotales=0;
  document.getElementById("fallos").textContent="Fallos: 0";
  nextRound();
};

document.getElementById("repaso").onclick=()=>{
  modoRepaso=true;
  juegoTerminado=true;
  clearMap();
  pintarMapaFinal(true);
  document.getElementById("nucleo").textContent="Modo repaso";
  document.getElementById("info").textContent="Nombres visibles";
};

// =====================
function nextRound(){
  clearMap();
  aciertoActual=false;
  fallosActual=0;

  if(index>=order.length){
    juegoTerminado=true;
    pintarMapaFinal(false);
    mostrarEstadisticas();
    return;
  }

  document.getElementById("nucleo").textContent=order[index].name;
  document.getElementById("progreso").textContent=`${index+1}/${order.length}`;

  nucleos.forEach(n=>{
    const c=L.circle([n.lat,n.lng],{
      radius:n.umbral,
      color:n.colorAcertado||"blue",
      fillOpacity:0.2
    }).addTo(map);

    c.on("click",()=>{
      if(juegoTerminado||aciertoActual||modoRepaso) return;
      if(n.name===order[index].name){
        aciertoActual=true;
        n.colorAcertado=fallosActual===0?"green":"orange";
        c.setStyle({color:n.colorAcertado,fillOpacity:0.4});
        mostrarMensaje("âœ”","ok");
      } else {
        fallosTotales++;
        fallosActual++;
        c.setStyle({color:"red"});
        document.getElementById("fallos").textContent=`Fallos: ${fallosTotales}`;
      }
    });
    zonas.push(c);
  });
}

// =====================
function pintarMapaFinal(permanente){
  nucleos.forEach(n=>{
    const c=L.circle([n.lat,n.lng],{
      radius:n.umbral,
      color:n.colorAcertado||"blue",
      fillOpacity:n.colorAcertado?0.4:0.2
    }).addTo(map);

    c.bindTooltip(n.name,{permanent:permanente});
    zonas.push(c);
  });
}

// =====================
function mostrarEstadisticas(){
  const verdes=nucleos.filter(n=>n.colorAcertado==="green").length;
  const naranjas=nucleos.filter(n=>n.colorAcertado==="orange").length;
  const total=nucleos.length;
  const porcentaje=Math.round((verdes/total)*100);

  const e=document.getElementById("estadisticas");
  e.innerHTML=`
    <h2>ðŸ“Š Resultados</h2>
    NÃºcleos: ${total}<br>
    Fallos totales: ${fallosTotales}<br>
    Perfectos (verde): ${verdes}<br>
    Con errores (naranja): ${naranjas}<br><br>
    ðŸŽ¯ PrecisiÃ³n perfecta: ${porcentaje}%
  `;
  e.style.display="block";
}

// =====================
function clearMap(){
  zonas.forEach(z=>map.removeLayer(z));
  zonas=[];
}
</script>

</body>
</html>
