<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Juego de n√∫cleos ‚Äì Teguise</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html,body{
  height:100%;
  margin:0;
  font-family:Arial,Helvetica,sans-serif;
}

#top{
  padding:8px;
  background:#0b7;
  color:#042;
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
}

#map{
  height:calc(100vh - 64px);
  width:100%;
}

button{
  padding:10px 14px;
  border-radius:6px;
  border:1px solid #999;
  cursor:pointer;
  font-size:0.9rem;
}

#nucleo{
  font-weight:bold;
  font-size:1rem;
}

.boton-volver{
  margin-left:auto;
  background:#fff;
  font-weight:bold;
}

#mensaje,#estadisticas{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:rgba(0,0,0,0.75);
  color:white;
  padding:20px;
  border-radius:12px;
  display:none;
  z-index:1000;
  text-align:center;
}

#mensaje{font-size:2.5rem;}

.leaflet-tooltip{
  font-size:0.9rem;
  padding:4px 6px;
}
</style>
</head>

<body>

<div id="top">
  <button id="start">‚ñ∂ Iniciar</button>
  <button id="repaso">üìç Repaso</button>
  <span id="progreso">‚Äî/‚Äî</span>
  <span id="nucleo">‚Äî</span>
  <span id="fallos">Fallos: 0</span>
  <button class="boton-volver" onclick="volverInicio()">‚¨Ö Volver</button>
</div>

<div id="mensaje"></div>
<div id="estadisticas"></div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// =====================
// N√öCLEOS TEGUISE
// =====================
const nucleos = [
  {name:"Teguise (casco hist√≥rico)", lat:29.06054, lng:-13.56068, umbral:70},
  {name:"Costa Teguise", lat:28.99896, lng:-13.48873, umbral:90},
  {name:"Tah√≠che", lat:29.01953, lng:-13.56887, umbral:65},
  {name:"Guatiza", lat:29.06644, lng:-13.47189, umbral:60},
  {name:"Los Valles", lat:29.07616, lng:-13.55587, umbral:55},
  {name:"Soo", lat:29.09964, lng:-13.65216, umbral:55},
  {name:"Mu√±ique", lat:29.09401, lng:-13.60379, umbral:50},
  {name:"Famara (pueblo)", lat:29.11832, lng:-13.56092, umbral:55},

  {name:"Playa de Famara", lat:29.11184, lng:-13.56698, umbral:90},
  {name:"Playa de las Cucharas", lat:28.99801, lng:-13.48986, umbral:70},

  {name:"Centro de Salud Costa Teguise", lat:28.99741, lng:-13.49078, umbral:45},
  {name:"Pol√≠gono Industrial de Tah√≠che", lat:29.01468, lng:-13.57562, umbral:60},
  {name:"Fundaci√≥n C√©sar Manrique", lat:29.01978, lng:-13.56997, umbral:45}
];

// =====================
let map=L.map('map').setView([29.05,-13.56],12);
L.tileLayer(
  'https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png'
).addTo(map);

setTimeout(()=>map.invalidateSize(),300);

// =====================
let order=[],index=0,zonas=[];
let fallosTotales=0,fallosActual=0;
let aciertoActual=false,juegoTerminado=false,modoRepaso=false;

// =====================
function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

function mostrarMensaje(txt){
  const m=document.getElementById("mensaje");
  m.textContent=txt;
  m.style.display="block";
  setTimeout(()=>{
    m.style.display="none";
    index++; 
    nextRound();
  },700);
}

// =====================
// BOTONES
// =====================
document.getElementById("start").onclick=()=>{
  modoRepaso=false;
  juegoTerminado=false;
  document.getElementById("estadisticas").style.display="none";

  nucleos.forEach(n=>delete n.colorAcertado);
  clearMap();

  order=shuffle([...nucleos]);
  index=0;
  fallosTotales=0;
  document.getElementById("fallos").textContent="Fallos: 0";

  nextRound();
};

document.getElementById("repaso").onclick=()=>{
  modoRepaso=true;
  juegoTerminado=true;
  clearMap();
  pintarMapaFinal(true);
  document.getElementById("nucleo").textContent="Modo repaso";
  document.getElementById("progreso").textContent="";
};

// =====================
function nextRound(){
  clearMap();
  aciertoActual=false;
  fallosActual=0;

  if(index>=order.length){
    juegoTerminado=true;
    pintarMapaFinal(false);
    mostrarEstadisticas();
    return;
  }

  document.getElementById("nucleo").textContent=order[index].name;
  document.getElementById("progreso").textContent=`${index+1}/${order.length}`;

  nucleos.forEach(n=>{
    const c=L.circle([n.lat,n.lng],{
      radius:n.umbral,
      color:n.colorAcertado||"blue",
      fillOpacity:0.25
    }).addTo(map);

    c.on("click",()=>{
      if(juegoTerminado||aciertoActual||modoRepaso) return;

      if(n.name===order[index].name){
        aciertoActual=true;
        n.colorAcertado=fallosActual===0?"green":"orange";
        c.setStyle({color:n.colorAcertado,fillOpacity:0.45});
        mostrarMensaje("‚úî");
      } else {
        fallosTotales++;
        fallosActual++;
        c.setStyle({color:"red"});
        document.getElementById("fallos").textContent=`Fallos: ${fallosTotales}`;
      }
    });

    zonas.push(c);
  });
}

// =====================
function pintarMapaFinal(permanente){
  nucleos.forEach(n=>{
    const c=L.circle([n.lat,n.lng],{
      radius:n.umbral,
      color:n.colorAcertado||"blue",
      fillOpacity:n.colorAcertado?0.45:0.25
    }).addTo(map);

    c.bindTooltip(n.name,{
      permanent:permanente,
      direction:"top"
    });

    zonas.push(c);
  });

  setTimeout(()=>map.invalidateSize(),300);
}

// =====================
function mostrarEstadisticas(){
  const verdes=nucleos.filter(n=>n.colorAcertado==="green").length;
  const naranjas=nucleos.filter(n=>n.colorAcertado==="orange").length;
  const total=nucleos.length;
  const porcentaje=Math.round((verdes/total)*100);

  const e=document.getElementById("estadisticas");
  e.innerHTML=`
    <h2>üìä Resultados</h2>
    N√∫cleos: ${total}<br>
    Fallos totales: ${fallosTotales}<br>
    Perfectos (verde): ${verdes}<br>
    Con errores (naranja): ${naranjas}<br><br>
    üéØ Precisi√≥n perfecta: ${porcentaje}%
  `;
  e.style.display="block";
}

// =====================
function clearMap(){
  zonas.forEach(z=>map.removeLayer(z));
  zonas=[];
}

function volverInicio(){
  window.location.href="/Territorio/index.html";
}
</script>

</body>
</html>
